# CLAUDE.md

このファイルは、このリポジトリで作業する際のClaude Code (claude.ai/code) へのガイダンスを提供します。

## プロジェクト概要

接続されたビデオカメラデバイスを自動検出し、シリアル番号で識別して、ビデオクリップをローカルフォルダに同期するビデオカメラ同期ツール（videoctl）です。ファイル変更時刻に基づく自動リネーム機能付き。

## コアアーキテクチャ

### 主要コンポーネント

- **main.sh**: 全機能を含む単一のbashスクリプト
- **pink/**: PINKデバイス用ビデオの保存先ディレクトリ (シリアル: 6CD0502F3121)
- **white/**: WHITEデバイス用ビデオの保存先ディレクトリ (シリアル: 6D6C904DF4D9)

### 主要関数

- `get_device_info_by_serial()`: system_profilerを使用してシリアル番号でUSBデバイスを検出
- `copy_video_clips()`: デバイス検出、rsync/cpフォールバックでのファイルコピー、自動リネームを処理
- `rename_files_by_date()`: ファイルを変更時刻でソートし%05d形式でリネーム (00000.MTS, 00001.MTS等)
- `eject_device()`: 同期後にマウントされたボリュームを安全に取り出し

### デバイス設定

このツールは2つの特定のビデオカメラデバイスを認識します：
- PINKデバイス: シリアル `6CD0502F3121`, アイコン 🐷
- WHITEデバイス: シリアル `6D6C904DF4D9`, アイコン 🐻‍❄️

両デバイスは `/Volumes/Untitled/AVCHD/BDMV/STREAM` としてマウントされ、.MTSビデオファイルが含まれることを想定。

## よく使うコマンド

### 基本的な使用法
```bash
# フル同期プロセスを実行（デバイス検出とファイルコピー）
./main.sh

# ヘルプ表示
./main.sh --help

# 既存ディレクトリ内のファイルのみリネーム
./main.sh --rename pink
./main.sh --rename white
./main.sh --rename /path/to/directory
```

### 開発用コマンド
```bash
# スクリプトを実行可能にする（必要に応じて）
chmod +x main.sh

# Makefile経由で実行（レガシー、古いsync.shを指している）
make

# コピーせずにデバイス検出をテスト
system_profiler SPUSBDataType | grep -A 20 "6CD0502F3121\|6D6C904DF4D9"
```

## ファイル名規則

ファイルは変更時刻に基づいて昇順で自動リネームされます：
- 元のファイル名: `00001.MTS`, `00023.MTS`, `00045.MTS`
- リネーム後: `00000.MTS`, `00001.MTS`, `00002.MTS` (date modifiedでソート済み)

## コミットメッセージスタイル

確立されたパターンに従って日本語プレフィックスを使用：
- `機能追加:` 新機能の場合
- `改善:` 改善の場合
- `リファクタ:` リファクタリングの場合
- `初期実装:` 初期実装の場合

## エラーハンドリング

スクリプトには既存フォルダのクリーンアップ確認と適切なフォールバックが含まれています：
- 進行状況表示付きrsync、利用できない場合はcpにフォールバック
- 使用中ボリュームのエラーハンドリング付き安全な取り出し
- デバイスタイプとステータスメッセージのカラーコード出力